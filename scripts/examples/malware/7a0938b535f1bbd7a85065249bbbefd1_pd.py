#
# Malware md5: 7a0938b535f1bbd7a85065249bbbefd1
# https://www.virustotal.com/gui/file/b60979f857ed87e348122d1288748a923c4f6a004474e88fa00bdf68964b1902/detection
#

# Tool Imports
from bph.tools.windows.nircmd import BphNirCmd as NirCmd
from bph.tools.windows.pd import BphPd as Pd
from bph.tools.windows.dumppe import BphDumpPE as DumpPE

# Core Imports
from bph.core.server.template import BphTemplateServer as TemplateServer
from bph.core.session import BphSession as Session
from bph.core.sample import BphLabFile as LabFile

session = Session(project_name='blackhat_arsenal_2019')
session.start()
session.set_launcher(move_sample=False)

templateserver = TemplateServer()
templateserver.start()

sample_exec = NirCmd(LabFile(session.launcher_abs_path))
sample_exec.configuration.execution.background_run = True
sample_exec.start_process(program='@sample@')
sample_exec.execute()

pd = Pd()
pd.dump_process(process_name='@sample_filename@')
pd.execute(delay=5)

files_found = pd.files()
    
for file_found in files_found:
    dumped_file = LabFile(file_found)
    print("[+] dumped file: {} md5: {}".format(file_found.split('__')[-1], dumped_file.md5))
        
kill_process = NirCmd()
kill_process.kill_process(program='@sample@')
kill_process.execute()
        
